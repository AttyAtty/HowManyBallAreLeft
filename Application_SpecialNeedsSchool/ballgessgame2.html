<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ボールの個数当てゲーム</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    canvas { background: #fff; display: block; margin: 20px auto; border: 2px solid #333; }
    button { font-size: 18px; margin: 5px; padding: 10px 20px; }
    .hidden { display: none; }
    #message { font-size: 24px; margin-top: 20px; }
    #feedback-mark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      font-weight: bold;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>ボールの個数当てゲーム</h1>
  <div id="start-screen">
    <button onclick="playClickSound(); startGame()">ゲーム開始</button>
    <button onclick="playClickSound(); setDifficulty(3)">かんたん（3個）</button>
    <button onclick="playClickSound(); setDifficulty(5)">ふつう（5個）</button>
    <button onclick="playClickSound(); setDifficulty(7)">むずかしい（7個）</button>
    <p id="difficulty-label">選択中：ふつう（5個）</p>
    <canvas id="start-animation" width="400" height="300"></canvas>
  </div>

  <div id="game-screen" class="hidden">
    <canvas id="game-canvas" width="400" height="300"></canvas>
    <div id="choices"></div>
    <p id="message"></p>
  </div>

  <div id="result-screen" class="hidden">
    <h2>結果発表！</h2>
    <p id="score"></p>
    <p id="result-message"></p>
    <button onclick="playClickSound(); restartGame()">スタート画面へ</button>
  </div>

  <div id="feedback-mark"></div>

  <audio id="bgm-start" src="Sky_Blue_POP.mp3" loop></audio>
  <audio id="bgm-game" src="なぞなぞハイキング.mp3" loop></audio>
  <audio id="correct-sound" src="クイズ正解1.mp3"></audio>
  <audio id="wrong-sound" src="クイズ不正解1.mp3"></audio>
  <audio id="click-sound" src="決定ボタンを押す39.mp3"></audio>
  <audio id="cheer-sound" src="歓声と拍手1.mp3"></audio>

  <script>
    const clickSound = document.getElementById('click-sound');
    const bgmStart = document.getElementById('bgm-start');
    const bgmGame = document.getElementById('bgm-game');
    const cheerSound = document.getElementById('cheer-sound');

    function playClickSound() {
      clickSound.currentTime = 0;
      clickSound.play();
    }

    function playStartBGM() {
      bgmGame.pause();
      bgmGame.currentTime = 0;
      bgmStart.play();
    }

    function playGameBGM() {
      bgmStart.pause();
      bgmStart.currentTime = 0;
      bgmGame.play();
    }

    function stopAllBGM() {
      bgmStart.pause();
      bgmStart.currentTime = 0;
      bgmGame.pause();
      bgmGame.currentTime = 0;
    }

    window.addEventListener('load', () => {
      playStartBGM();
    });
  </script>

  <!-- ゲームのロジックスクリプト -->
  <script>
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const choicesDiv = document.getElementById('choices');
    const message = document.getElementById('message');
    const scoreDisplay = document.getElementById('score');
    const resultMessage = document.getElementById('result-message');
    const feedbackMark = document.getElementById('feedback-mark');

    let totalRounds = 10;
    let currentRound = 0;
    let difficulty = 5;
    let correctCount = 0;
    let ballCount = 5;
    let hiddenCount = 0;

    function setDifficulty(n) {
      difficulty = n;
      document.getElementById('difficulty-label').textContent = `選択中：${n === 3 ? 'かんたん' : n === 5 ? 'ふつう' : 'むずかしい'}（${n}個）`;
    }

    function startGame() {
      currentRound = 0;
      correctCount = 0;
      startScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      playGameBGM();
      nextRound();
    }

    function showResult() {
      gameScreen.classList.add('hidden');
      resultScreen.classList.remove('hidden');
      stopAllBGM();
      cheerSound.play();
      playStartBGM();

      const score = 100 - (totalRounds - correctCount) * 5;
      scoreDisplay.textContent = `あなたの得点は ${score} 点です！`;

      if (score >= 90) {
        resultMessage.textContent = '花丸！すばらしい！';
      } else if (score >= 70) {
        resultMessage.textContent = '〇 よくできました！';
      } else {
        resultMessage.textContent = '二重丸 次はもっとがんばろう！';
      }
    }

    function restartGame() {
      resultScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
    }

    // 立体的な箱とボールを描画する簡易版
    function drawBox(openRight = false) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 背景箱
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(100, 100, 200, 100); // 前面

      // 中身の影（奥行き再現）
      ctx.fillStyle = '#654321';
      ctx.fillRect(100, 100, 200, 20); // 底面影

      if (openRight) {
        ctx.clearRect(280, 100, 20, 100); // 右側面を開ける
      } else {
        ctx.fillStyle = '#5C4033';
        ctx.fillRect(280, 100, 20, 100); // 右側面閉じ
      }
    }

    function drawBalls(num, insideBox = true) {
      ctx.fillStyle = 'red';
      for (let i = 0; i < num; i++) {
        const x = 120 + (i % 5) * 30;
        const y = insideBox ? 130 + Math.floor(i / 5) * 30 : 80;
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function nextRound() {
      drawBox();
      drawBalls(difficulty, false);

      setTimeout(() => {
        drawBox();
        drawBalls(difficulty);

        setTimeout(() => {
          hiddenCount = Math.floor(Math.random() * difficulty);
          const shown = difficulty - hiddenCount;

          drawBox(true);
          drawBalls(shown);

          showChoices(hiddenCount);
        }, 1000);
      }, 1000);
    }

    function showChoices(answer) {
      choicesDiv.innerHTML = '';
      for (let i = answer - 1; i <= answer + 2; i++) {
        if (i >= 0) {
          const btn = document.createElement('button');
          btn.textContent = `${i}個`; btn.onclick = () => checkAnswer(i);
          choicesDiv.appendChild(btn);
        }
      }
    }

    function checkAnswer(selected) {
      const mark = selected === hiddenCount ? '〇' : '×';
      const color = mark === '〇' ? 'red' : 'blue';
      feedbackMark.textContent = mark;
      feedbackMark.style.color = color;
      feedbackMark.classList.remove('hidden');

      setTimeout(() => {
        feedbackMark.classList.add('hidden');
        if (mark === '〇') {
          correctCount++;
          document.getElementById('correct-sound').play();
        } else {
          document.getElementById('wrong-sound').play();
        }
        currentRound++;
        if (currentRound < totalRounds) {
          nextRound();
        } else {
          showResult();
        }
      }, 1500);
    }
  </script>
</body>
</html>
