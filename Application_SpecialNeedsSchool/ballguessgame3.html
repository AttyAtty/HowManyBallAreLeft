<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ボールはなんこ入ってるかな？</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    canvas { background: #fff; display: block; margin: 20px auto; border: 2px solid #333; }
    button { font-size: 18px; margin: 5px; padding: 10px 20px; }
    .hidden { display: none; }
    #message { font-size: 24px; margin-top: 20px; }
    #overlay-symbol {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      font-weight: bold;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>

<script>
   const startCanvas = document.getElementById('start-animation');
   const startCtx = startCanvas.getContext('2d');
  let angle = 0;

  function drawRotatingCube() {
    const ctx = startCtx;
    const w = 100, h = 100, d = 100;
    const cx = startCanvas.width / 2;
    const cy = startCanvas.height / 2;

    ctx.clearRect(0, 0, startCanvas.width, startCanvas.height);

    angle += 0.01;

    const cosA = Math.cos(angle);
    const sinA = Math.sin(angle);

    // Points in 3D space
    const cube = [
      { x: -w / 2, y: -h / 2, z: -d / 2 },
      { x: w / 2, y: -h / 2, z: -d / 2 },
      { x: w / 2, y: h / 2, z: -d / 2 },
      { x: -w / 2, y: h / 2, z: -d / 2 },
      { x: -w / 2, y: -h / 2, z: d / 2 },
      { x: w / 2, y: -h / 2, z: d / 2 },
      { x: w / 2, y: h / 2, z: d / 2 },
      { x: -w / 2, y: h / 2, z: d / 2 },
    ];

    // Apply rotation and perspective
    const projected = cube.map(p => {
      const x = p.x * cosA - p.z * sinA;
      const z = p.x * sinA + p.z * cosA;
      const scale = 300 / (z + 400);
      return {
        x: cx + x * scale,
        y: cy + p.y * scale
      };
    });

    const faces = [
      [0, 1, 2, 3], // front
      [4, 5, 6, 7], // back
      [0, 1, 5, 4], // top
      [2, 3, 7, 6], // bottom
      [1, 2, 6, 5], // right
      [0, 3, 7, 4]  // left
    ];

const faceColors = ["#003366", "#0055A4", "#0077CC", "#3399FF", "#66B2FF", "#99CCFF"];

    // Draw faces
    for (let i = 0; i < faces.length; i++) {
      const face = faces[i];
      ctx.beginPath();
      ctx.moveTo(projected[face[0]].x, projected[face[0]].y);
      for (let j = 1; j < face.length; j++) {
        ctx.lineTo(projected[face[j]].x, projected[face[j]].y);
      }
      ctx.closePath();
      ctx.fillStyle = faceColors[i];
      ctx.fill();
      ctx.stroke();
    }

    requestAnimationFrame(drawRotatingCube);
  }

  window.addEventListener('load', () => {
    drawRotatingCube(); // start cube rotation
  });
</script>


  <h1>ボールのこすうあてゲーム</h1>
  <div id="start-screen">
      <button onclick="playClick(); setDifficulty(3)">かんたん（3こ）</button>
      <button onclick="playClick(); setDifficulty(5)">ふつう（5こ）</button>
      <button onclick="playClick(); setDifficulty(7)">むずかしい（7こ）</button>
      <button onclick="playClick(); startGame()">ゲームかいし</button>
    <p id="difficulty-label">せんたくちゅう：ふつう（5こ）</p>
    <canvas id="start-animation" width="400" height="300"></canvas>
  </div>

  <div id="game-screen" class="hidden">
    <canvas id="game-canvas" width="400" height="300"></canvas>
    <div id="choices"></div>
    <p id="message"></p>
    <div id="overlay-symbol"></div>
  </div>

  <div id="result-screen" class="hidden">
    <h2>けっかはっぴょう！</h2>
    <p id="score"></p>
    <p id="result-message"></p>
    <img id="result-symbol" style="height:100px;display:none;margin:20px auto;display:block;" alt="結果シンボル">
    <button onclick="playClick(); restartGame()">スタートがめんへ</button>
  </div>

  <audio id="bgm-start" src="Sky_Blue_POP.mp3" loop></audio>
  <audio id="bgm-game" src="なぞなぞハイキング.mp3" loop></audio>
  <audio id="correct-sound" src="クイズ正解1.mp3"></audio>
  <audio id="wrong-sound" src="クイズ不正解1.mp3"></audio>
  <audio id="click-sound" src="決定ボタンを押す39.mp3"></audio>
  <audio id="cheer-sound" src="歓声と拍手1.mp3"></audio>

  <script>
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const choicesDiv = document.getElementById('choices');
    const message = document.getElementById('message');
    const scoreDisplay = document.getElementById('score');
    const resultMessage = document.getElementById('result-message');
    const overlaySymbol = document.getElementById('overlay-symbol');

    const bgmStart = document.getElementById('bgm-start');
    const bgmGame = document.getElementById('bgm-game');
    const clickSound = document.getElementById('click-sound');
    const correctSound = document.getElementById('correct-sound');
    const wrongSound = document.getElementById('wrong-sound');
    const cheerSound = document.getElementById('cheer-sound');

    let totalRounds = 10;
    let currentRound = 0;
    let difficulty = 5;
    let correctCount = 0;
    let ballCount = 5;
    let hiddenCount = 0;

    function playClick() {
      clickSound.currentTime = 0;
      clickSound.play();
    }

    function setDifficulty(n) {
      difficulty = n;
      document.getElementById('difficulty-label').textContent = `せんたくちゅう：${n === 3 ? 'かんたん' : n === 5 ? 'ふつう' : 'むずかしい'}（${n}こ）`;
    }

    function startGame() {
      currentRound = 0;
      correctCount = 0;
      startScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      bgmStart.pause();
      bgmStart.currentTime = 0;
      bgmGame.play();
      nextRound();
    }

    function nextRound() {
      currentRound++;
      ballCount = difficulty;
      hiddenCount = Math.floor(Math.random() * ballCount);
      const visibleCount = ballCount - hiddenCount;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      animateBallsIntoBox(ballCount, () => {
        drawBox();
        setTimeout(() => {
          shakeBox(() => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBox(true);
            drawBallsInsideBox(hiddenCount);
            animateBallsOutOfBox(visibleCount, () => {
              showChoices();
            });
          });
        }, 800);
      });
    }

    function animateBallsIntoBox(n, callback) {
      const positions = Array.from({ length: n }, (_, i) => ({ x: 100 + i * 30, y: 0 }));
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBox();
        positions.forEach(pos => {
          if (pos.y < 160) pos.y += 5;
          drawBall(pos.x, pos.y);
        });
        if (positions[0].y < 160) requestAnimationFrame(animate);
        else callback();
      }
      animate();
    }

    function animateBallsOutOfBox(n, callback) {
      const positions = Array.from({ length: n }, (_, i) => ({ x: 230 + i * 30, y: 200 }));
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBox(true);
        drawBallsInsideBox(hiddenCount);
        let done = true;
        positions.forEach(pos => {
          if (pos.y < 270) {
            pos.y += 5;
            done = false;
          }
          drawBall(pos.x, pos.y);
        });
        if (!done) requestAnimationFrame(animate);
        else callback();
      }
      animate();
    }

    function drawBall(x, y) {
      const gradient = ctx.createRadialGradient(x - 5, y - 5, 5, x, y, 20);
      gradient.addColorStop(0, 'white');
      gradient.addColorStop(1, 'red');
      ctx.beginPath();
      ctx.arc(x, y, 20, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = 'darkred';
      ctx.stroke();
    }

    function drawBallsInsideBox(n) {
      for (let i = 0; i < n; i++) {
        drawBall(100 + i * 40, 160);
      }
    }

    function drawBox(openRight = false) {
      const x = 80, y = 100, w = 240, h = 120;
      ctx.fillStyle = '#3092CA';
      ctx.fillRect(x, y, w, h);

      ctx.fillStyle = '#44ABE6';
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + 15, y - 15);
      ctx.lineTo(x + w + 15, y - 15);
      ctx.lineTo(x + w, y);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = '#134C6E';
      ctx.beginPath();
      ctx.moveTo(x + w, y);
      ctx.lineTo(x + w + 15, y - 15);
      ctx.lineTo(x + w + 15, y + h - 15);
      ctx.lineTo(x + w, y + h);
      ctx.closePath();
      ctx.fill();

      if (openRight) {
        ctx.clearRect(x + w / 2, y, w / 2, h);

        ctx.fillStyle = '#19577A';
        ctx.fillRect(x + w / 2, y, w / 2, h-15);

        ctx.fillStyle = '#1E7BAF';
        ctx.fillRect(x + w / 2, y + h - 15, w / 2, 15);

        drawLine(x + w / 2, y, x + w / 2, y + h);
        
      }
      
      drawLine(x, y, x + 15, y - 15);
      drawLine(x + w, y, x + w + 15, y - 15);
      drawLine(x + w, y + h, x + w + 15, y + h - 15);
      drawLine(x + 15, y - 15, x + w + 15, y - 15);
      drawLine(x + w + 15, y - 15, x + w + 15, y + h - 15);
      
      ctx.strokeStyle = 'black';
      ctx.strokeRect(x, y, w, h);
      
    }

    function drawLine(x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = 'black';
      ctx.stroke();
      ctx.closePath();
    }

    function shakeBox(callback) {
      let count = 0;
      const interval = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(Math.random() * 6 - 3, Math.random() * 6 - 3);
        drawBox();
        ctx.restore();
        count++;
        if (count > 10) {
          clearInterval(interval);
          callback();
        }
      }, 50);
    }

    function showChoices() {
      choicesDiv.innerHTML = '';
      const options = shuffle([hiddenCount, hiddenCount + 1, hiddenCount + 2, hiddenCount + 3].filter(n => n <= ballCount));
      options.forEach(n => {
        const btn = document.createElement('button');
        btn.textContent = `${n}こ`;
        btn.onclick = () => handleAnswer(n);
        choicesDiv.appendChild(btn);
      });
      message.textContent = 'はこのなかにのこっているボールのかずは？';
    }

    function handleAnswer(answer) {
      overlaySymbol.style.display = 'block';
      if (answer === hiddenCount) {
        message.textContent = 'せいかい！';
        correctCount++;
        correctSound.play();
        overlaySymbol.textContent = '〇';
        overlaySymbol.style.color = 'red';
      } else {
        message.textContent = 'ふせいかい...';
        wrongSound.play();
        overlaySymbol.textContent = '×';
        overlaySymbol.style.color = 'blue';
      }
      setTimeout(() => {
        overlaySymbol.style.display = 'none';
        if (currentRound >= totalRounds) showResult();
        else nextRound();
      }, 1200);
    }

    function showResult() {
      gameScreen.classList.add('hidden');
      resultScreen.classList.remove('hidden');
      bgmGame.pause();
      bgmGame.currentTime = 0;
      cheerSound.play();

      const score = 100 - (totalRounds - correctCount) * 5;
      scoreDisplay.textContent = `あなたの得点は ${score} 点です！`;

        const resultSymbol = document.getElementById('result-symbol');
        resultSymbol.style.display = 'block';
        if (score >= 90) {
          resultMessage.textContent = '花丸！すばらしい！';
          resultSymbol.src = 'hanamaru.png';
          resultSymbol.alt = '花丸';
        } else if (score >= 70) {
          resultMessage.textContent = '〇 よくできました！';
          resultSymbol.src = 'circle.png';
          resultSymbol.alt = '〇';
        } else {
          resultMessage.textContent = '二重丸 次はもっとがんばろう！';
          resultSymbol.src = 'doublecircle.png';
          resultSymbol.alt = '二重丸';
        }
    }

    function restartGame() {
      resultScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
      bgmStart.play();
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

     const startCanvas1 = document.getElementById('start-animation');
     const startCtx1 = startCanvas1.getContext('2d');
    let startFrame = 0;
    function startAnim() {
      startCtx1.clearRect(0, 0, startCanvas1.width, startCanvas1.height);
      const y = 150 + Math.sin(startFrame * 0.1) * 10;
      const gradient = startCtx1.createRadialGradient(197, y - 3, 2, 200, y, 20);
      gradient.addColorStop(0, 'white');
      gradient.addColorStop(1, 'red');
      startCtx1.beginPath();
      startCtx1.arc(200, y, 20, 0, Math.PI * 2);
      startCtx1.fillStyle = gradient;
      startCtx1.fill();
      startCtx1.strokeStyle = 'darkred';
      startCtx1.stroke();
      startFrame++;
      requestAnimationFrame(startAnim);
    }

    window.onload = () => {
      bgmStart.play();
      startAnim();
    }
  </script>
</body>
</html>
