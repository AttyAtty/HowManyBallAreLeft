<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>のこりはなんこ？</title>
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      background: #f0f0f0; 
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 {
      font-size: 48px;
      color: #2E86AB;
      margin: 30px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    h2 {
      font-size: 36px;
      color: #2E86AB;
      margin: 20px 0;
    }
    canvas { 
      background: #fff; 
      display: block; 
      margin: 20px auto; 
      border: 3px solid #333;
      max-width: 90vw;
      height: auto;
    }
    button { 
      font-size: 28px; 
      margin: 15px; 
      padding: 20px 40px; 
      border: none;
      border-radius: 15px;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      min-width: 250px;
    }
    button:hover {
      background: linear-gradient(45deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
  .hidden { display: none !important; }
    #game-screen {
      position: relative;
    }
    #message { 
      font-size: 32px; 
      margin-top: 30px; 
      font-weight: bold;
      color: #333;
    }
    #choices {
      margin: 30px 0;
    }
    #choices button {
      margin: 10px;
      min-width: 150px;
      font-size: 48px;
    }
    #overlay-symbol {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
  font-size: 220px;
      font-weight: bold;
      display: none;
      z-index: 9999;
      text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
    }
    /* 個数表示スタイル */
    .ball-count-info {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
      color: white;
      font-size: 32px;
      font-weight: bold;
      padding: 15px 30px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      animation: bounceIn 0.6s ease-out;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      min-width: 350px;
      width: 60vw;
      max-width: 90vw;
    }
    @keyframes bounceIn {
      0% { transform: translateX(-50%) scale(0.3); opacity: 0; }
      50% { transform: translateX(-50%) scale(1.1); opacity: 1; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
    /* レベル選択画面 */
    #level-screen button {
      display: block;
      margin: 20px auto;
      width: 80%;
      max-width: 400px;
    }
    /* 結果画面のスタイル */
    #result-screen h2 {
  font-size: 64px;
      color: #2E86AB;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    #score {
  font-size: 48px;
      font-weight: bold;
      color: #1565C0;
      margin: 30px 0;
    }
    .score-big {
    font-size: 1.7em;
    font-weight: bold;
    color: #FF6B35;
    display: inline-block;
    margin-top: 10px;
  }
    #result-message {
  font-size: 56px;
      font-weight: bold;
      margin: 40px 0;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
      line-height: 1.2;
    }
    #result-symbol {
      width: 60%;
      max-width: 300px;
      height: auto;
      margin: 30px auto;
      display: block;
      border-radius: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    #result-screen button {
      font-size: 32px;
      padding: 20px 50px;
      margin-top: 40px;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      min-width: 300px;
    }
    
    .credit {
      font-size: 16px;
      color: #666;
      margin-top: 10px;
      margin-bottom: 0;
      text-align: center;
      opacity: 0.7;
      letter-spacing: 0.05em;
    }
    
    /* iPad Air用のメディアクエリ */
    @media screen and (min-width: 768px) and (max-width: 1024px) {
      body {
        padding: 40px;
      }
      h1 {
        font-size: 64px;
        margin: 40px 0;
      }
      button {
        font-size: 32px;
        padding: 25px 50px;
        min-width: 300px;
      }
      #message {
        font-size: 40px;
      }
      #overlay-symbol {
        font-size: 300px;
      }
      #result-message {
        font-size: 56px;
      }
      #score {
        font-size: 44px;
      }
      canvas {
        width: 600px;
        height: 450px;
      }
    }
    
    /* 横向き表示用 */
    @media screen and (orientation: landscape) {
      body {
        padding: 20px 40px;
      }
      canvas {
        width: 500px;
        height: 375px;
      }
      #result-symbol {
        width: 40%;
        max-width: 250px;
      }
    }

#settings-gear {
  position: fixed;
  top: 18px;
  right: 24px;
  z-index: 2000;
  cursor: pointer;
  background: none;
  border: none;
  outline: none;
  transition: transform 0.1s;
}
#settings-gear:active {
  transform: scale(0.95) rotate(20deg);
}
#settings-modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35);
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.settings-content {
  background: #fff;
  border-radius: 18px;
  padding: 32px 24px 24px 24px;
  min-width: 320px;
  max-width: 90vw;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  text-align: left;
  position: relative;
}
.settings-content h2 {
  margin-top: 0;
  font-size: 2em;
  color: #2E86AB;
  text-align: center;
}
.settings-section {
  margin: 18px 0;
}
.settings-section label {
  font-size: 1.1em;
  margin-right: 12px;
}
.settings-section input[type="range"] {
  width: 60%;
  vertical-align: middle;
  margin-left: 10px;
}
.settings-section h3 {
  margin: 8px 0 4px 0;
  font-size: 1.1em;
  color: #444;
}
.credit-list {
  margin: 0 0 0 18px;
  padding: 0;
  font-size: 0.98em;
  color: #666;
}
.credit-list li {
  margin-bottom: 2px;
  list-style: disc;
}
#settings-close {
  display: block;
  margin: 18px auto 0 auto;
  font-size: 1.1em;
  padding: 10px 32px;
  border-radius: 10px;
  background: linear-gradient(45deg, #4CAF50, #45a049);
  color: #fff;
  border: none;
  cursor: pointer;
}
#settings-close:hover {
  background: linear-gradient(45deg, #45a049, #4CAF50);
}
#pause-btn {
  font-size: 1.1em;
  padding: 10px 32px;
  border-radius: 10px;
  background: #E57373;
  color: #fff;
  border: none;
  cursor: pointer;
}
#pause-btn:hover {
  background: #C62828;
}
  </style>
</head>
<body>

  <h1 id="main-title">のこりはなんこ？</h1>
  <div id="start-screen">
    <button onclick="playClick(); showLevelScreen()">スタート</button>
    <canvas id="start-animation" width="600" height="450"></canvas>
  </div>

  <div id="level-screen" class="hidden">
    <h2>レベルをえらんでね</h2>
    <button onclick="playClick(); setDifficultyAndStart(3)">かんたん（3こ）</button>
    <button onclick="playClick(); setDifficultyAndStart(5)">ふつう（5こ）</button>
    <button onclick="playClick(); setDifficultyAndStart(10)">むずかしい（10こ）</button>
  </div>

  <div id="game-screen" class="hidden">
    <div id="ball-count-display" class="ball-count-info">5このボールを入れるよ</div>
    <canvas id="game-canvas" width="600" height="450"></canvas>
    <p id="message"></p>
    <div id="choices"></div>
    <div id="overlay-symbol"></div>
  </div>

  <div id="result-screen" class="hidden">
    <h2>けっかはっぴょう！</h2>
    <p id="score"></p>
    <p id="result-message"></p>
    <img id="result-symbol" alt="結果シンボル">
    <button onclick="playClick(); restartGame()">スタートがめんへ</button>
  </div>

  <!-- 歯車メニュー -->
<div id="settings-gear" tabindex="0" aria-label="設定" title="設定">
  <svg width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="#eee" stroke="#888" stroke-width="2"/><g stroke="#888" stroke-width="2"><circle cx="20" cy="20" r="8" fill="none"/><g><line x1="20" y1="4" x2="20" y2="10"/><line x1="20" y1="30" x2="20" y2="36"/><line x1="4" y1="20" x2="10" y2="20"/><line x1="30" y1="20" x2="36" y2="20"/><line x1="8.3" y1="8.3" x2="13" y2="13"/><line x1="27" y1="27" x2="31.7" y2="31.7"/><line x1="8.3" y1="31.7" x2="13" y2="27"/><line x1="27" y1="13" x2="31.7" y2="8.3"/></g></g></svg>
</div>
<div id="settings-modal" class="hidden" role="dialog" aria-modal="true" aria-label="設定メニュー">
  <div class="settings-content">
    <h2>設定</h2>
    <div class="settings-section">
      <label><input type="checkbox" id="bgm-toggle" checked> BGM（背景音楽）</label>
      <input type="range" id="bgm-volume" min="0" max="1" step="0.01" value="1">
    </div>
    <div class="settings-section">
      <label><input type="checkbox" id="se-toggle" checked> SE（効果音）</label>
      <input type="range" id="se-volume" min="0" max="1" step="0.01" value="1">
    </div>
    <div class="settings-section">
      <label><input type="checkbox" id="voice-toggle" checked> ボイス</label>
    </div>
    <div class="settings-section" id="pause-section" style="display:none;">
      <button id="pause-btn">プレイをやめる</button>
    </div>
    <div class="settings-section">
      <h3>クレジット</h3>
      <ul class="credit-list">
        <li>開発：アハメド アティフ</li>
        <li>声：VOICEVOX ずんだもん</li>
      </ul>
    </div>
    <button id="settings-close">とじる</button>
  </div>
</div>

  <audio id="bgm-start" src="Sky_Blue_POP.mp3" loop></audio>
  <audio id="bgm-game" src="なぞなぞハイキング.mp3" loop></audio>
  <audio id="correct-sound" src="クイズ正解1.mp3"></audio>
  <audio id="wrong-sound" src="クイズ不正解1.mp3"></audio>
  <audio id="click-sound" src="決定ボタンを押す39.mp3"></audio>
  <audio id="cheer-sound" src="歓声と拍手1.mp3"></audio>

  <script>
    const startScreen = document.getElementById('start-screen');
    const levelScreen = document.getElementById('level-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const choicesDiv = document.getElementById('choices');
    const message = document.getElementById('message');
    const scoreDisplay = document.getElementById('score');
    const resultMessage = document.getElementById('result-message');
    const overlaySymbol = document.getElementById('overlay-symbol');

    const bgmStart = document.getElementById('bgm-start');
    const bgmGame = document.getElementById('bgm-game');
    const clickSound = document.getElementById('click-sound');
    const correctSound = document.getElementById('correct-sound');
    const wrongSound = document.getElementById('wrong-sound');
    const cheerSound = document.getElementById('cheer-sound');

    let totalRounds = 10;
    let currentRound = 0;
    let difficulty = 5;
    let correctCount = 0;
    let ballCount = 5;
    let hiddenCount = 0;

    function playClick() {
      clickSound.currentTime = 0;
      clickSound.play();
    }

    // 個数表示機能
    function showBallCount(count) {
      const countDisplay = document.getElementById('ball-count-display');
      countDisplay.textContent = `${count}このボールを入れるよ`;
      countDisplay.style.display = 'block';


      // ボイスON時のみ案内音声を再生
      if (window.voiceEnabled !== false) {
        let wavFile = '';
        if (count === 3) wavFile = '3ball.wav';
        else if (count === 5) wavFile = '5ball.wav';
        else if (count === 10) wavFile = '10ball.wav';
        if (wavFile) {
          const audio = new Audio(wavFile);
          audio.volume = 1.0; // 案内音声は最大
          // BGMを一時的に下げる
          const originalBgmVolume = bgmGame.volume;
          bgmGame.volume = 0.2;
          audio.play();
          audio.addEventListener('ended', () => {
            bgmGame.volume = originalBgmVolume;
          });
        }
      }

      setTimeout(() => {
        countDisplay.style.display = 'none';
      }, 3000);
    }

    function showLevelScreen() {
      startScreen.classList.add('hidden');
      levelScreen.classList.remove('hidden');
      // スタートボタンでBGM再生
      bgmStart.currentTime = 0;
      bgmStart.play();
    }

    function setDifficultyAndStart(n) {
      difficulty = n;
      startGame();
    }

    function startGame() {
      currentRound = 0;
      correctCount = 0;
      levelScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      bgmStart.pause();
      bgmStart.currentTime = 0;
      bgmGame.play();
      nextRound();
    }

    function nextRound() {
      currentRound++;
      ballCount = difficulty;
      hiddenCount = Math.floor(Math.random() * ballCount);
      const visibleCount = ballCount - hiddenCount;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 個数を表示・音声案内
      showBallCount(ballCount);
      
      // 3秒待ってからボールを1秒間表示し、その後アニメーション開始
      setTimeout(() => {
        // まずボールを1秒間表示
        setHoleVisibility(false, false);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBox();
        // animateBallsIntoBoxの開始位置と同じに揃える
        const w = 360, h = 180;
        const x = (canvas.width - w) / 2;
        const y = (canvas.height - h) / 2;
        const gap = 56;
        const startX = x + w / 2 - ((ballCount - 1) * gap) / 2;
        const baseY = 30; // animateBallsIntoBoxの初期y
        for (let i = 0; i < ballCount; i++) {
          drawBall(startX + i * gap, baseY);
        }
        setTimeout(() => {
          setHoleVisibility(true, false); // 上面穴のみ表示
          animateBallsIntoBox(ballCount, () => {
            setHoleVisibility(false, false); // 両方非表示
            drawBox();
            setTimeout(() => {
              shakeBox(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setHoleVisibility(false, true); // 正面穴のみ表示
                drawBox();
                drawBallsInsideBox(hiddenCount);
                animateBallsOutOfBox(visibleCount, () => {
                  setHoleVisibility(false, false); // 両方非表示
                  showChoices();
                });
              });
            }, 800);
          });
        }, 1000); // 1秒間ボールを表示
      }, 3200); // 個数表示が消える少し後にアニメーション開始
    }

    function animateBallsIntoBox(n, callback) {
      // ボールが箱の上面中央の穴に吸い込まれるように
      ballCount = difficulty;
      const w = 360, h = 180;
      const x = (canvas.width - w) / 2;
      const y = (canvas.height - h) / 2;
      const holeX = x + w / 2;
      const holeY = y - 25;
      const gap = 48;
      const startX = x + w / 2 - ((ballCount - 1) * gap) / 2;
      const positions = Array.from({ length: n }, (_, i) => ({ x: startX + i * gap, y: 30, phase: 0 }));
      let arrived = 0;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBox();
        positions.forEach((pos, i) => {
          if (pos.phase === 0) {
            // 横から穴の上まで移動（ゆっくり）
            if (Math.abs(pos.x - holeX) > 2) {
              pos.x += (holeX - pos.x) * 0.08;
            } else {
              pos.x = holeX;
              pos.phase = 1;
            }
          }
          if (pos.phase === 1) {
            // 穴の上から下へ落ちる（ゆっくり）
            if (pos.y < holeY) {
              pos.y += 3;
            } else {
              pos.y = holeY;
              pos.phase = 2;
              arrived++;
            }
          }
          if (pos.phase < 2) {
            drawBall(pos.x, pos.y);
          }
        });
        if (arrived < n) requestAnimationFrame(animate);
        else setTimeout(callback, 300);
      }
      animate();
    }

    function animateBallsOutOfBox(n, callback) {
      // 箱の穴から1つずつ出てきて横に並ぶアニメーション
      const w = 360, h = 180;
      const x = (canvas.width - w) / 2;
      const y = (canvas.height - h) / 2;
      const holeX = x + w - 60; // 少し右に
      const holeY = y + h - 30;
      const gap = 56;
      // const startX = holeX - ((n - 1) * gap) / 2;
      const startX = holeX - w - 10;
      let outCount = 0;
      const positions = [];
      function animateOneBall() {
        let xBall = holeX - 40, yBall = holeY;
        // 正面穴から下に出てくる演出（少し下に落ちる）
        function drop() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawBox();
          positions.forEach(p => drawBall(p.x, p.y));
          if (yBall < holeY + 100) {
            yBall += 5;
            drawBall(xBall, yBall);
            requestAnimationFrame(drop);
          } else {
            // 横に並べる位置に移動
            let targetX = startX + outCount * gap;
            function moveSide() {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              drawBox();
              positions.forEach(p => drawBall(p.x, p.y));
              if (Math.abs(xBall - targetX) > 2) {
                xBall += (targetX - xBall) * 0.18;
                drawBall(xBall, yBall);
                requestAnimationFrame(moveSide);
              } else {
                xBall = targetX;
                drawBall(xBall, yBall);
                positions.push({ x: xBall, y: yBall });
                outCount++;
                if (outCount < n) {
                  setTimeout(animateOneBall, 250);
                } else {
                  setTimeout(callback, 300);
                }
              }
            }
            moveSide();
          }
        }
        drop();
      }
      animateOneBall();
    }

    function drawBall(x, y) {
      const gradient = ctx.createRadialGradient(x - 5, y - 5, 5, x, y, 20);
      gradient.addColorStop(0, 'white');
      gradient.addColorStop(1, 'red');
      ctx.beginPath();
      ctx.arc(x, y, 25, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = 'darkred';
      ctx.stroke();
    }

    function drawBallsInsideBox(n) {
  // 箱の中央穴の下に横並びで描画
  const w = 360, h = 180;
  const x = (canvas.width - w) / 2;
  const y = (canvas.height - h) / 2;
  const baseX = x + w / 2;
  const baseY = y + 40; // 箱の上面から少し下
  const gap = 56;
  const startX = baseX - ((n - 1) * gap) / 2;
  for (let i = 0; i < n; i++) {
    drawBall(startX + i * gap, baseY);
  }
}

    // 黒穴の表示制御フラグ
    let showTopHole = true;
    let showFrontHole = false;
    function setHoleVisibility(top, front) {
      showTopHole = top;
      showFrontHole = front;
    }

    function drawBox(openRight = false) {
      const w = 360, h = 180;
      const x = (canvas.width - w) / 2 - 40;
      const y = (canvas.height - h) / 2;
      ctx.fillStyle = '#3092CA';
      ctx.fillRect(x, y, w, h);

  ctx.fillStyle = '#44ABE6';
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + 50, y - 50);
  ctx.lineTo(x + w + 50, y - 50);
  ctx.lineTo(x + w, y);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = '#134C6E';
  ctx.beginPath();
  ctx.moveTo(x + w, y);
  ctx.lineTo(x + w + 50, y - 50);
  ctx.lineTo(x + w + 50, y + h - 50);
  ctx.lineTo(x + w, y + h);
  ctx.closePath();
  ctx.fill();

      if (openRight) {
        ctx.clearRect(x + w / 2, y, w / 2, h);

        ctx.fillStyle = '#19577A';
        ctx.fillRect(x + w / 2, y, w / 2, h-50);

        ctx.fillStyle = '#1E7BAF';
        ctx.fillRect(x + w / 2, y + h - 50, w / 2, 50);

        drawLine(x + w / 2, y, x + w / 2, y + h);
      }

      drawLine(x, y, x + 50, y - 50);
      drawLine(x + w, y, x + w + 50, y - 50);
      drawLine(x + w, y + h, x + w + 50, y + h - 50);
      drawLine(x + 50, y - 50, x + w + 50, y - 50);
      drawLine(x + w + 50, y - 50, x + w + 50, y + h - 50);

      // 箱の上面中央に斜め楕円の穴を描画（右にずらす）
      if (showTopHole) {
        ctx.save();
        ctx.beginPath();
        const ellipseX = x + w / 2 + 40; // 右に40pxずらす
        const ellipseY = y - 50 / 2;
        ctx.ellipse(ellipseX, ellipseY, 38, 18, Math.atan2(-50, w), 0, Math.PI * 2);
        ctx.fillStyle = '#222';
        ctx.globalAlpha = 0.7;
        ctx.fill();
        ctx.globalAlpha = 1.0;
        ctx.restore();
      }
      // 箱の正面右下に黒い円の穴を描画
      if (showFrontHole) {
        ctx.save();
        ctx.beginPath();
        const frontCircleX = x + w - 60; // 少し右に
        const frontCircleY = y + h - 30;
        ctx.arc(frontCircleX, frontCircleY, 28, 0, Math.PI * 2);
        ctx.fillStyle = '#222';
        ctx.globalAlpha = 0.7;
        ctx.fill();
        ctx.globalAlpha = 1.0;
        ctx.restore();
      }

      ctx.strokeStyle = 'black';
      ctx.strokeRect(x, y, w, h);
    }

    function drawLine(x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = 'black';
      ctx.stroke();
      ctx.closePath();
    }

    function shakeBox(callback) {
      let count = 0;
      const interval = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(Math.random() * 6 - 3, Math.random() * 6 - 3);
        drawBox();
        ctx.restore();
        count++;
        if (count > 10) {
          clearInterval(interval);
          callback();
        }
      }, 50);
    }

    function showChoices() {
      choicesDiv.innerHTML = '';
      const options = shuffle([hiddenCount, hiddenCount + 1, hiddenCount + 2, hiddenCount + 3].filter(n => n <= ballCount));
      options.forEach(n => {
        const btn = document.createElement('button');
        btn.textContent = `${n}`;
        btn.classList.add('choice-btn');
        btn.onclick = () => {
          // 全ボタン無効化＆色変更
          const allBtns = choicesDiv.querySelectorAll('button');
          allBtns.forEach(b => {
            b.disabled = true;
            b.style.background = 'linear-gradient(45deg, #388E3C, #1B5E20)';
            b.style.cursor = 'not-allowed';
          });
          btn.style.background = 'linear-gradient(45deg, #FF9800, #F57C00)'; // 押したボタンはオレンジ系
          handleAnswer(n);
        };
        choicesDiv.appendChild(btn);
      });
      message.innerHTML = 'はこのなかにのこっている<br>ボールのかずは？';
    }

    function handleAnswer(answer) {
      overlaySymbol.style.display = 'block';
      if (answer === hiddenCount) {
        //message.textContent = 'せいかい！';
        correctCount++;
        correctSound.play();
        overlaySymbol.textContent = '〇';
        overlaySymbol.style.color = 'red';
      } else {
        //message.textContent = 'ふせいかい...';
        wrongSound.play();
        overlaySymbol.textContent = '×';
        overlaySymbol.style.color = 'blue';
      }
      setTimeout(() => {
        overlaySymbol.style.display = 'none';
        if (currentRound >= totalRounds) showResult();
        else nextRound();
      }, 1200);
    }

    function showResult() {
  gameScreen.classList.add('hidden');
  resultScreen.classList.remove('hidden');
  document.getElementById('main-title').style.display = 'none';
  message.textContent = '';
  message.style.display = 'none'; // 結果発表時は「残りはなんこ？」を非表示
  // 選択肢ボタンの状態リセット
  const allBtns = choicesDiv.querySelectorAll('button');
  allBtns.forEach(b => {
    b.disabled = false;
    b.style.background = '';
    b.style.cursor = '';
  });
  bgmGame.pause();
  bgmGame.currentTime = 0;

  const score = 100 - (totalRounds - correctCount) * 5;
  scoreDisplay.innerHTML = `あなたのとくてんは<br><span class="score-big">${score} てん!</span>`;

  const resultSymbol = document.getElementById('result-symbol');
  resultSymbol.style.display = 'block';

  // 点数に応じたwavファイル名・コメント・画像
  let commentWav = '';
  let commentText = '';
  let commentColor = '';
  let symbolSrc = '';
  let symbolAlt = '';
  if (score >= 90) {
    commentWav = 'morethan90.wav';
    commentText = 'すばらしい！';
    commentColor = '#FF6B35';
    symbolSrc = 'hanamaru.png';
    symbolAlt = '花丸';
  } else if (score >= 70) {
    commentWav = '90to70.wav';
    commentText = 'よくできました！';
    commentColor = '#E53E3E';
    symbolSrc = 'doublecircle.png';
    symbolAlt = '二重丸';
  } else {
    commentWav = 'under70.wav';
    commentText = '次はもっとがんばろう！';
    commentColor = '#3182CE';
    symbolSrc = 'circle.png';
    symbolAlt = '〇';
  }
  // コメント・画像は常時表示
  resultMessage.textContent = commentText;
  resultMessage.style.color = commentColor;
  resultSymbol.src = symbolSrc;
  resultSymbol.alt = symbolAlt;

  // 歓声再生
  cheerSound.currentTime = 0;
  cheerSound.play();
  cheerSound.onended = () => {
    // ボイスON時のみコメント音声再生
    if (window.voiceEnabled !== false) {
      const commentAudio = new Audio(commentWav);
      commentAudio.volume = 1.0;
      commentAudio.play();
    }
  };
    }

    function restartGame() {
      resultScreen.classList.add('hidden');
      levelScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
      document.getElementById('main-title').style.display = 'block';
      message.style.display = 'block'; // 再スタート時は再表示
      bgmStart.play();
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    const startCanvas1 = document.getElementById('start-animation');
    const startCtx1 = startCanvas1.getContext('2d');
    let startFrame = 0;
    let startAnimId = null;
    function startAnim() {
      startCtx1.clearRect(0, 0, startCanvas1.width, startCanvas1.height);
      const centerX = startCanvas1.width / 2;
      const centerY = startCanvas1.height / 2;
      const radius = 120;
      const ballCount = 10;
      for (let i = 0; i < ballCount; i++) {
        const angle = (2 * Math.PI / ballCount) * i + startFrame * 0.01;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        // drawBallのctxをstartCtx1で明示的に渡す
        drawBallForStartAnim(x, y);
      }
      startFrame++;
      startAnimId = requestAnimationFrame(startAnim);
    }
    function stopStartAnim() {
      if (startAnimId) {
        cancelAnimationFrame(startAnimId);
        startAnimId = null;
      }
    }
    // start画面用のdrawBall（ctx固定）
    function drawBallForStartAnim(x, y) {
      const gradient = startCtx1.createRadialGradient(x - 5, y - 5, 5, x, y, 20);
      gradient.addColorStop(0, 'white');
      gradient.addColorStop(1, 'red');
      startCtx1.beginPath();
      startCtx1.arc(x, y, 25, 0, Math.PI * 2);
      startCtx1.fillStyle = gradient;
      startCtx1.fill();
      startCtx1.strokeStyle = 'darkred';
      startCtx1.stroke();
    }

    // 画面遷移時にcanvas表示/非表示とアニメ制御
    function showStartScreen() {
      startScreen.classList.remove('hidden');
      document.getElementById('main-title').style.display = 'block';
      startCanvas1.style.display = 'block';
      startAnim();
    }
    function hideStartScreen() {
      startScreen.classList.add('hidden');
      startCanvas1.style.display = 'none';
      stopStartAnim();
    }

    // 既存のshowLevelScreen, startGame, restartGameを上書き
    showLevelScreen = function() {
      hideStartScreen();
      levelScreen.classList.remove('hidden');
      bgmStart.currentTime = 0;
      bgmStart.play();
    }
    startGame = function() {
      levelScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      bgmStart.pause();
      bgmStart.currentTime = 0;
      bgmGame.play();
      hideStartScreen();
      currentRound = 0;
      correctCount = 0;
      nextRound();
    }
    restartGame = function() {
      resultScreen.classList.add('hidden');
      levelScreen.classList.add('hidden');
      showStartScreen();
      message.style.display = 'block';
      bgmStart.play();
    }

    // 歯車メニューの制御
const settingsGear = document.getElementById('settings-gear');
const settingsModal = document.getElementById('settings-modal');
const settingsClose = document.getElementById('settings-close');
const bgmToggle = document.getElementById('bgm-toggle');
const bgmVolume = document.getElementById('bgm-volume');
const seToggle = document.getElementById('se-toggle');
const seVolume = document.getElementById('se-volume');
const voiceToggle = document.getElementById('voice-toggle');
const pauseSection = document.getElementById('pause-section');
const pauseBtn = document.getElementById('pause-btn');

// 歯車クリックでメニュー表示
settingsGear.addEventListener('click', () => {
  settingsModal.classList.remove('hidden');
  // ゲーム画面時のみ中断ボタン表示
  if (!gameScreen.classList.contains('hidden')) {
    pauseSection.style.display = '';
  } else {
    pauseSection.style.display = 'none';
  }
});
// 閉じるボタン
settingsClose.addEventListener('click', () => {
  settingsModal.classList.add('hidden');
});
// モーダル外クリックで閉じる
settingsModal.addEventListener('click', e => {
  if (e.target === settingsModal) settingsModal.classList.add('hidden');
});
// ESCキーで閉じる
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') settingsModal.classList.add('hidden');
});
// BGM/SE/ボイスのオンオフ・音量
bgmToggle.addEventListener('change', () => {
  bgmStart.muted = bgmGame.muted = !bgmToggle.checked;
});
bgmVolume.addEventListener('input', () => {
  bgmStart.volume = bgmGame.volume = parseFloat(bgmVolume.value);
});
seToggle.addEventListener('change', () => {
  clickSound.muted = correctSound.muted = wrongSound.muted = cheerSound.muted = !seToggle.checked;
});
seVolume.addEventListener('input', () => {
  clickSound.volume = correctSound.volume = wrongSound.volume = cheerSound.volume = parseFloat(seVolume.value);
});
voiceToggle.addEventListener('change', () => {
  window.voiceEnabled = voiceToggle.checked;
});
// プレイ中断ボタン（例: ゲーム画面を非表示にしてスタート画面に戻す）
pauseBtn.addEventListener('click', () => {
  settingsModal.classList.add('hidden');
  gameScreen.classList.add('hidden');
  showStartScreen();
  bgmGame.pause();
  bgmStart.play();
});
    // 初期表示
    window.onload = () => {
      showStartScreen();
    }
  </script>
</body>
</html>
